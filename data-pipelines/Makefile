# ANDI Data Pipelines Makefile
.PHONY: help up down logs status clean test install health

# Default target
help:
	@echo "ANDI Data Pipelines - Available commands:"
	@echo ""
	@echo "  up          - Start all services (Airflow, ClickHouse, monitoring)"
	@echo "  down        - Stop all services"
	@echo "  logs        - View service logs"
	@echo "  status      - Check service status"
	@echo "  health      - Run health checks"
	@echo "  install     - Install ETL dependencies"
	@echo "  test        - Run tests"
	@echo "  clean       - Clean up volumes and images"
	@echo "  reset       - Reset Airflow database"
	@echo ""

# Start all services
up:
	@echo "ðŸš€ Starting ANDI Data Pipelines..."
	docker-compose up -d
	@echo "âœ… Services starting. Use 'make status' to check progress."
	@echo ""
	@echo "ðŸŒ Access URLs:"
	@echo "  Airflow UI:    http://localhost:8080 (admin/admin)"
	@echo "  ClickHouse:    http://localhost:8123"
	@echo "  Grafana:       http://localhost:3000 (admin/admin)"
	@echo "  Prometheus:    http://localhost:9090"

# Stop all services
down:
	@echo "ðŸ›‘ Stopping ANDI Data Pipelines..."
	docker-compose down
	@echo "âœ… Services stopped."

# View logs
logs:
	docker-compose logs -f

# Check service status
status:
	@echo "ðŸ“Š Service Status:"
	@echo ""
	docker-compose ps
	@echo ""
	@echo "ðŸ” Health Checks:"
	@docker-compose exec -T airflow-webserver curl -f http://localhost:8080/health 2>/dev/null && echo "âœ… Airflow: Healthy" || echo "âŒ Airflow: Unhealthy"
	@docker-compose exec -T clickhouse wget --spider -q http://localhost:8123/ping 2>/dev/null && echo "âœ… ClickHouse: Healthy" || echo "âŒ ClickHouse: Unhealthy"
	@curl -f http://localhost:3000/api/health 2>/dev/null >/dev/null && echo "âœ… Grafana: Healthy" || echo "âŒ Grafana: Unhealthy"
	@curl -f http://localhost:9090/-/healthy 2>/dev/null >/dev/null && echo "âœ… Prometheus: Healthy" || echo "âŒ Prometheus: Unhealthy"

# Run comprehensive health checks
health:
	@echo "ðŸ¥ Running comprehensive health checks..."
	@echo ""
	
	# Test database connections
	cd etl && npm run test-connections || echo "âŒ Database connection test failed"
	
	# Test Airflow DAGs
	@docker-compose exec -T airflow-scheduler airflow dags list | grep -q "andi_daily_etl" && echo "âœ… Daily ETL DAG loaded" || echo "âŒ Daily ETL DAG not found"
	@docker-compose exec -T airflow-scheduler airflow dags list | grep -q "andi_ciq_sync" && echo "âœ… CIQ Sync DAG loaded" || echo "âŒ CIQ Sync DAG not found"
	
	# Test ClickHouse
	@docker-compose exec -T clickhouse clickhouse-client --query "SELECT 1" 2>/dev/null && echo "âœ… ClickHouse query test passed" || echo "âŒ ClickHouse query test failed"

# Install ETL dependencies
install:
	@echo "ðŸ“¦ Installing ETL dependencies..."
	cd etl && npm install
	@echo "âœ… Dependencies installed."

# Run tests
test:
	@echo "ðŸ§ª Running tests..."
	cd etl && npm test
	@echo "âœ… Tests completed."

# Clean up volumes and images
clean:
	@echo "ðŸ§¹ Cleaning up Docker resources..."
	docker-compose down -v --remove-orphans
	docker system prune -f
	@echo "âœ… Cleanup completed."

# Reset Airflow database
reset:
	@echo "ðŸ”„ Resetting Airflow database..."
	docker-compose down
	docker volume rm data-pipelines_postgres-db-volume 2>/dev/null || true
	docker-compose up airflow-init
	docker-compose up -d
	@echo "âœ… Airflow database reset completed."

# Development shortcuts
dev-up:
	@echo "ðŸ”§ Starting development environment..."
	docker-compose up -d postgres redis clickhouse
	@echo "âœ… Core services started for development."

dev-down:
	docker-compose down

# Backup ClickHouse data
backup:
	@echo "ðŸ’¾ Creating ClickHouse backup..."
	mkdir -p backups
	docker-compose exec -T clickhouse clickhouse-client --query "BACKUP DATABASE andi_warehouse TO Disk('default', 'backup_$(shell date +%Y%m%d_%H%M%S).tar')"
	@echo "âœ… Backup completed."

# View specific service logs
logs-airflow:
	docker-compose logs -f airflow-webserver airflow-scheduler airflow-worker

logs-clickhouse:
	docker-compose logs -f clickhouse

logs-etl:
	docker-compose logs -f airflow-worker

# Quick DAG testing
test-daily-dag:
	docker-compose exec airflow-scheduler airflow dags test andi_daily_etl $(shell date +%Y-%m-%d)

test-ciq-dag:
	docker-compose exec airflow-scheduler airflow dags test andi_ciq_sync $(shell date +%Y-%m-%d)