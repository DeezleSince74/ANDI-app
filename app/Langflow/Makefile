# ANDI Langflow Makefile
.PHONY: help dev prod up down logs status health init flows clean test backup

# Default target
help:
	@echo "ANDI Langflow - Available commands:"
	@echo ""
	@echo "  Development:"
	@echo "    dev              - Start Langflow IDE for development"
	@echo "    up               - Start development environment"
	@echo "    down             - Stop development environment"
	@echo "    logs             - View development logs"
	@echo "    status           - Check development status"
	@echo ""
	@echo "  Production:"
	@echo "    prod             - Start production runtime environment"
	@echo "    prod-down        - Stop production environment"
	@echo "    prod-logs        - View production logs"
	@echo "    prod-status      - Check production status"
	@echo ""
	@echo "  Management:"
	@echo "    health           - Run comprehensive health checks"
	@echo "    init             - Initialize database and setup"
	@echo "    flows            - List and manage flows"
	@echo "    backup           - Create backup of flows and data"
	@echo "    restore          - Restore from backup"
	@echo "    clean            - Clean up containers and volumes"
	@echo "    test             - Run integration tests"
	@echo ""

# Development commands
dev:
	@echo "ğŸš€ Starting Langflow IDE for development..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "âœ… Langflow IDE started successfully!"
	@echo ""
	@echo "ğŸŒ Access URLs:"
	@echo "  Langflow IDE:      http://localhost:7860"
	@echo "  PostgreSQL:        localhost:5433"
	@echo "  Redis:             localhost:6380"
	@echo ""
	@echo "ğŸ“– Login credentials:"
	@echo "  Email:             $$(grep LANGFLOW_SUPERUSER_EMAIL .env 2>/dev/null | cut -d= -f2 || echo 'admin@andi.local')"
	@echo "  Password:          $$(grep LANGFLOW_SUPERUSER_PASSWORD .env 2>/dev/null | cut -d= -f2 || echo 'langflow_admin')"

up: dev

down:
	@echo "ğŸ›‘ Stopping Langflow development environment..."
	docker-compose -f docker-compose.dev.yml down
	@echo "âœ… Development environment stopped."

logs:
	@echo "ğŸ“‹ Viewing Langflow development logs (Ctrl+C to exit)..."
	docker-compose -f docker-compose.dev.yml logs -f langflow

status:
	@echo "ğŸ“Š Langflow Development Status:"
	@echo ""
	docker-compose -f docker-compose.dev.yml ps
	@echo ""
	@echo "ğŸ” Health Checks:"
	@curl -s http://localhost:7860/api/v1/auto_login 2>/dev/null >/dev/null && echo "âœ… Langflow IDE: Healthy" || echo "âŒ Langflow IDE: Unhealthy"
	@docker-compose -f docker-compose.dev.yml exec -T langflow-postgres pg_isready -U langflow_user -d langflow_db 2>/dev/null >/dev/null && echo "âœ… PostgreSQL: Healthy" || echo "âŒ PostgreSQL: Unhealthy"
	@docker-compose -f docker-compose.dev.yml exec -T langflow-redis redis-cli ping 2>/dev/null | grep -q PONG && echo "âœ… Redis: Healthy" || echo "âŒ Redis: Unhealthy"

# Production commands
prod:
	@echo "ğŸš€ Starting Langflow production runtime..."
	docker-compose -f docker-compose.prod.yml up -d
	@echo "âœ… Langflow runtime started successfully!"
	@echo ""
	@echo "ğŸŒ Access URLs:"
	@echo "  Langflow API:      http://localhost:7860/api/v1"
	@echo "  Health Check:      http://localhost:7860/api/v1/version"

prod-down:
	@echo "ğŸ›‘ Stopping Langflow production environment..."
	docker-compose -f docker-compose.prod.yml down
	@echo "âœ… Production environment stopped."

prod-logs:
	@echo "ğŸ“‹ Viewing Langflow production logs (Ctrl+C to exit)..."
	docker-compose -f docker-compose.prod.yml logs -f langflow-runtime

prod-status:
	@echo "ğŸ“Š Langflow Production Status:"
	@echo ""
	docker-compose -f docker-compose.prod.yml ps
	@echo ""
	@echo "ğŸ” Health Checks:"
	@curl -s http://localhost:7860/api/v1/version 2>/dev/null >/dev/null && echo "âœ… Langflow Runtime: Healthy" || echo "âŒ Langflow Runtime: Unhealthy"

# Health and management commands
health:
	@echo "ğŸ¥ Running comprehensive Langflow health checks..."
	@echo ""
	
	# Check if containers are running
	@echo "ğŸ“¦ Container Status:"
	@docker-compose -f docker-compose.dev.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "Development environment not running"
	@echo ""
	
	# Test Langflow API
	@echo "ğŸ” API Health Checks:"
	@if curl -s http://localhost:7860/api/v1/version >/dev/null 2>&1; then \
		echo "âœ… Langflow API: Responding"; \
		echo "   Version: $$(curl -s http://localhost:7860/api/v1/version 2>/dev/null | jq -r '.version // "unknown"' 2>/dev/null || echo 'unknown')"; \
	else \
		echo "âŒ Langflow API: Not responding"; \
	fi
	
	# Test database connectivity
	@echo "ğŸ—„ï¸ Database Health:"
	@if docker-compose -f docker-compose.dev.yml exec -T langflow-postgres pg_isready -U langflow_user -d langflow_db >/dev/null 2>&1; then \
		echo "âœ… PostgreSQL: Connected"; \
		echo "   Database: $$(docker-compose -f docker-compose.dev.yml exec -T langflow-postgres psql -U langflow_user -d langflow_db -t -c "SELECT current_database();" 2>/dev/null | xargs || echo 'unknown')"; \
	else \
		echo "âŒ PostgreSQL: Connection failed"; \
	fi
	
	# Test ANDI database connectivity (for connectors)
	@echo "ğŸ”— ANDI Integration Health:"
	@if nc -z localhost 5432 2>/dev/null; then \
		echo "âœ… ANDI Database: Accessible"; \
	else \
		echo "âš ï¸  ANDI Database: Not accessible (expected if not running)"; \
	fi

init:
	@echo "ğŸ”§ Initializing Langflow environment..."
	@echo ""
	
	# Check if .env exists
	@if [ ! -f ".env" ]; then \
		echo "ğŸ“ Creating .env file from template..."; \
		cp .env.example .env; \
		echo "âš ï¸  Please review and update .env with your configuration"; \
	else \
		echo "âœ… .env file exists"; \
	fi
	
	# Create necessary directories
	@echo "ğŸ“ Creating directories..."
	@mkdir -p flows custom_components init nginx postgres redis
	@echo "âœ… Directories created"
	
	# Start services and wait for health
	@echo "ğŸš€ Starting services..."
	@make dev
	@echo "â³ Waiting for services to be ready..."
	@sleep 10
	
	# Initialize Sentry monitoring
	@echo "ğŸ” Initializing Sentry monitoring..."
	@python init_sentry.py 2>/dev/null || echo "âš ï¸  Sentry initialization failed (may not be configured)"
	
	# Run health check
	@make health

flows:
	@echo "ğŸ“Š Langflow Flows Management:"
	@echo ""
	
	# List flows if API is available
	@if curl -s http://localhost:7860/api/v1/flows >/dev/null 2>&1; then \
		echo "ğŸ“‹ Available Flows:"; \
		curl -s http://localhost:7860/api/v1/flows 2>/dev/null | jq -r '.flows[]? | "  - \(.name) (\(.id))"' 2>/dev/null || echo "  No flows found or unable to parse response"; \
	else \
		echo "âŒ Langflow API not available. Start development environment first:"; \
		echo "   make dev"; \
	fi
	
	@echo ""
	@echo "ğŸ“ Flow Files:"
	@ls -la flows/ 2>/dev/null || echo "  No flow files found in ./flows/"

backup:
	@echo "ğŸ’¾ Creating Langflow backup..."
	@mkdir -p backups
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	echo "ğŸ“¦ Backing up flows and configuration..."; \
	tar -czf "backups/langflow_backup_$$timestamp.tar.gz" flows/ custom_components/ .env 2>/dev/null || true; \
	if [ -f "backups/langflow_backup_$$timestamp.tar.gz" ]; then \
		echo "âœ… Backup created: backups/langflow_backup_$$timestamp.tar.gz"; \
	else \
		echo "âš ï¸  Backup created but may be incomplete"; \
	fi
	
	# Database backup
	@if docker-compose -f docker-compose.dev.yml ps langflow-postgres | grep -q "Up"; then \
		echo "ğŸ—„ï¸ Backing up database..."; \
		docker-compose -f docker-compose.dev.yml exec -T langflow-postgres pg_dump -U langflow_user -d langflow_db > "backups/langflow_db_backup_$$timestamp.sql" 2>/dev/null || echo "âŒ Database backup failed"; \
		if [ -f "backups/langflow_db_backup_$$timestamp.sql" ]; then \
			echo "âœ… Database backup created: backups/langflow_db_backup_$$timestamp.sql"; \
		fi \
	else \
		echo "âš ï¸  Database not running, skipping database backup"; \
	fi

restore:
	@echo "ğŸ”„ Restoring Langflow from backup..."
	@echo "Usage: make restore BACKUP_FILE=backup_20241201_120000.tar.gz"
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "âŒ Please specify BACKUP_FILE"; \
		echo "Available backups:"; \
		ls -la backups/ 2>/dev/null || echo "No backups found"; \
		exit 1; \
	fi
	@if [ -f "backups/$(BACKUP_FILE)" ]; then \
		echo "ğŸ“¦ Restoring from backups/$(BACKUP_FILE)..."; \
		tar -xzf "backups/$(BACKUP_FILE)" 2>/dev/null && echo "âœ… Files restored successfully" || echo "âŒ File restore failed"; \
	else \
		echo "âŒ Backup file not found: backups/$(BACKUP_FILE)"; \
	fi

clean:
	@echo "ğŸ§¹ Cleaning up Langflow environment..."
	@echo "âš ï¸  This will remove all containers and volumes!"
	@read -p "Are you sure? Type 'yes' to continue: " confirm && [ "$$confirm" = "yes" ] || exit 1
	
	@echo "ğŸ›‘ Stopping services..."
	@docker-compose -f docker-compose.dev.yml down -v 2>/dev/null || true
	@docker-compose -f docker-compose.prod.yml down -v 2>/dev/null || true
	
	@echo "ğŸ—‘ï¸ Removing volumes..."
	@docker volume rm andi-langflow-data-dev andi-langflow-postgres-dev andi-langflow-redis-dev 2>/dev/null || true
	@docker volume rm andi-langflow-data-prod andi-langflow-postgres-prod andi-langflow-redis-prod 2>/dev/null || true
	
	@echo "âœ… Cleanup completed."

test:
	@echo "ğŸ§ª Running Langflow integration tests..."
	@echo ""
	
	# Test development environment
	@echo "Testing development environment..."
	@make dev
	@sleep 15
	
	# Test API endpoints
	@echo "ğŸ” Testing API endpoints..."
	@if curl -s http://localhost:7860/api/v1/version >/dev/null; then \
		echo "âœ… Version endpoint: OK"; \
	else \
		echo "âŒ Version endpoint: Failed"; \
	fi
	
	@if curl -s http://localhost:7860/api/v1/flows >/dev/null; then \
		echo "âœ… Flows endpoint: OK"; \
	else \
		echo "âŒ Flows endpoint: Failed"; \
	fi
	
	# Test database connectivity
	@echo "ğŸ—„ï¸ Testing database connectivity..."
	@if docker-compose -f docker-compose.dev.yml exec -T langflow-postgres psql -U langflow_user -d langflow_db -c "SELECT 1;" >/dev/null 2>&1; then \
		echo "âœ… Database connection: OK"; \
	else \
		echo "âŒ Database connection: Failed"; \
	fi
	
	@echo ""
	@echo "ğŸ‰ Integration tests completed!"

# Development shortcuts
reset: clean init
	@echo "ğŸ”„ Langflow environment reset completed!"

restart:
	@make down
	@sleep 2
	@make dev

# Production shortcuts
prod-restart:
	@make prod-down
	@sleep 2
	@make prod

# Monitoring and observability
sentry:
	@echo "ğŸ” Initializing and testing Sentry monitoring for Langflow..."
	@echo ""
	
	# Check Sentry configuration
	@echo "ğŸ“‹ Sentry Configuration:"
	@if [ -n "$${SENTRY_DSN}" ]; then \
		echo "âœ… SENTRY_DSN: Configured"; \
	else \
		echo "âŒ SENTRY_DSN: Not configured"; \
		echo "   Set SENTRY_DSN environment variable"; \
	fi
	@echo "   Environment: $${SENTRY_ENVIRONMENT:-development}"
	@echo "   Sample Rate: $${SENTRY_TRACES_SAMPLE_RATE:-1.0}"
	@echo ""
	
	# Initialize Sentry
	@echo "ğŸš€ Initializing Sentry..."
	@python init_sentry.py
	@echo ""
	
	# Test Sentry integration
	@echo "ğŸ§ª Testing Sentry integration..."
	@python -c "
import sys
sys.path.append('./utils')
from sentry import sentry_monitor, track_flow
import time

if sentry_monitor.initialized:
    print('âœ… Sentry initialization: Success')
    
    # Test flow tracking
    @track_flow('test_flow', 'Test Flow')
    def test_function():
        time.sleep(0.1)
        return {'status': 'success', 'metrics': {'duration': 0.1}}
    
    try:
        result = test_function()
        print('âœ… Flow tracking: Success')
    except Exception as e:
        print(f'âŒ Flow tracking: Failed - {e}')
    
    # Test error capture
    try:
        sentry_monitor.log_flow_error('test_flow', 'Test Flow', Exception('Test error'), {'test': True})
        print('âœ… Error capture: Success')
    except Exception as e:
        print(f'âŒ Error capture: Failed - {e}')
        
    print('âœ… Sentry testing completed successfully!')
else:
    print('âŒ Sentry not initialized - check configuration')
    sys.exit(1)
" 2>/dev/null || echo "âŒ Sentry testing failed"